import{c as $,_ as q}from"./index-ac97dbd4.js";import{b as z,r as f,w as E,c as O,l as P,i as r,f as _,n as D,e as T,g as x,h as U,k as g,p as j,P as A,q as I}from"./vendor-3bd669b1.js";function R(c,n,s=0){const a=n.width/n.height,l={width:c.width-s*2,height:c.height-s*2},i={width:l.width,height:l.width/a,scale:l.width/n.width},u={width:a*l.height,height:l.height,scale:l.height/n.height};return i.height<=l.height?i:u}function N(c){return{x:c.width/2,y:c.height/2}}async function F(c,n,s,a,l){const i=document.createElement("canvas");i.width=n.width,i.height=n.height;const u=i.getContext("2d");u.drawImage(c,0,0,n.width,n.height);const b=u.getImageData(0,0,c.width,c.height),d=b.data,C=255*s/100;function p(t,h){d[t]=d[t+1]=d[t+2]=Math.max(Math.min(255,h),0)}for(let t=0;t<d.length;t+=4){const h=(d[t]+d[t+1]+d[t+2])/3;let k=h>C?255:0;if(p(t,a?255-k:k),l){const o=h-k,e=i.width*4;p(t+4,d[t+4]+o*7/16),p(t-4+e,d[t-4+e]+o*3/16),p(t+e,d[t+e]+o*5/16),p(t+4+e,d[t+4+e]+o*1/16)}}return u.putImageData(b,0,0),await createImageBitmap(i)}function H(c){const n=new Uint8Array(Math.ceil(c.data.length/4/8));for(let s=0;s<c.data.length/4;s++)n[Math.floor(s/8)]|=(c.data[s*4]?1:0)<<7-s%8;return n}const L={class:"ant-upload-drag-icon"},W=g("p",{class:"ant-upload-text"},"点击选择图片，或将图片直接拖放到此处",-1),G=["src"],J=g("p",null," 你可以调整阈值，以使图片达到最适合墨水屏的效果。 ",-1),K=g("h4",null,"阈值",-1),Q={style:{marginTop:"32px"}},X=z({__name:"Eink",setup(c){const n=$(),s=f(),a=document.createElement("canvas");a.width=128,a.height=296;const l=f(50),i=f(!1),u=f(!0);function b({file:o}){s.value=o}function d(){l.value=50,i.value=!1,s.value=void 0}const C=f();E([s,l,i,u],async([o,e,v,w])=>{const m=o&&await createImageBitmap(o);C.value=m&&await F(m,R(a,m),e,v,w)});const p=f();E(C,o=>{const e=a.getContext("2d");if(e.clearRect(0,0,a.width,a.height),o){const v=R(a,o),w=N(a),m=N(v);e.clearRect(0,0,a.width,a.height),e.fillStyle="white",e.fillRect(0,0,a.width,a.height),e.save(),e.translate(w.x,w.y),e.drawImage(o,-m.x,-m.y,v.width,v.height),e.restore()}p.value=a.toDataURL()});const t=f(),h=O(()=>{var o;return typeof t.value<"u"&&t.value!=((o=n.einkImage)==null?void 0:o.id)});async function k(){t.value=Math.round(Math.random()*1e3);const o=a.getContext("2d"),e=H(o.getImageData(0,0,a.width,a.height));await n.setEinkImage(t.value,e)}return(o,e)=>{const v=x("a-upload-dragger"),w=x("a-col"),m=x("a-slider"),M=x("a-checkbox"),B=x("a-button"),S=x("a-space"),V=x("a-row");return s.value?(U(),T(V,{key:1,type:"flex",gutter:[32,32]},{default:_(()=>[r(w,{flex:"0"},{default:_(()=>[g("img",{src:p.value,class:D(o.$style.preview)},null,10,G)]),_:1}),r(w,{flex:"auto",xs:24,lg:8},{default:_(()=>[J,g("p",null,[K,r(m,{value:l.value,"onUpdate:value":e[0]||(e[0]=y=>l.value=y),disabled:h.value},null,8,["value","disabled"])]),g("p",null,[r(M,{checked:i.value,"onUpdate:checked":e[1]||(e[1]=y=>i.value=y),disabled:h.value},{default:_(()=>[I("反色")]),_:1},8,["checked","disabled"])]),g("p",null,[r(M,{checked:u.value,"onUpdate:checked":e[2]||(e[2]=y=>u.value=y),disabled:h.value},{default:_(()=>[I("抖动")]),_:1},8,["checked","disabled"])]),g("p",Q,[r(S,null,{default:_(()=>[r(B,{type:"primary",onClick:k,loading:h.value},{default:_(()=>[I("更新到设备")]),_:1},8,["loading"]),r(B,{type:"text",onClick:d,disabled:h.value},{default:_(()=>[I("重新选择")]),_:1},8,["disabled"])]),_:1})])]),_:1})]),_:1})):(U(),P("div",{key:0,class:D(o.$style.selector)},[r(v,{accept:"image/*","custom-request":b,"show-upload-list":!1},{default:_(()=>[g("p",L,[r(j(A))]),W]),_:1})],2))}}}),Y="_selector_39x60_1",Z="_preview_39x60_13",ee={selector:Y,preview:Z},te={$style:ee},ne=q(X,[["__cssModules",te]]);export{ne as default};
